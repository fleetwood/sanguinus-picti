extends ../layouts/full
include ../mixins/gallery-edit
include ../mixins/artist-selector

block page_content
    article.box.post

        section
            h3 New Page
            form#new-page.form-horizontal
                fieldset

                    // TITLE
                    .form-group
                        label.col-md-4.control-label(for='title', placeholder="Title") Title
                        .col-md-5
                            input#title.form-control.input-md(name='title', type='text', required='Needs a title!', value=data.title)
                            span.help-block Give it a snazzy title

                    // URL
                    .form-group
                        label.col-md-4.control-label(for='textinput', placeholder="Url") Url
                        .col-md-5
                            input#url.form-control.input-md(name='url', type='text', required='Did you delete the url?', disabled='true', value=data.url)

                    // SUMMARY
                    .form-group
                        label.col-md-4.control-label(for='summary', required="Summary pls.") Summary
                        .col-md-4
                            textarea#summary.form-control(name='summary')=data.summary

                    // GALLERY
                    .form-group
                        label.col-med-4.control-label(for='images', placeholder='Images') Gallery
                        .col-md-4
                            +gallery-edit(data.images)

                    // BODY
                    .form-group
                        label.col-md-4.control-label(for='body') Body
                        .col-md-4
                            textarea#body.form-control(name='body', required="Say something nice.")=data.body

                    // FEATURED
                    .form-group
                        label.col-md-4.control-label(for='featured') Feature Page
                        .col-md-4
                            input#featured(type='checkbox', name='featured', checked=data.featured)

                    // SELECT AUTHORS
                    .form-group
                        label.col-md-4.control-label(for='featured') Select Artists
                        .col-md-4
                            +artist-selector

                    // PAGE TYPE
                    .form-group
                        label.col-md-4.control-label(for='pageType') Page Type
                        .col-md-4
                            .radio
                                label(for='pageType-0')
                                    input#pageType-0(type='radio', name='pageType', value='blog', checked=data.pageType=='blog')
                                    | Blog
                                    
                            .radio
                                label(for='pageType-1')
                                    input#pageType-1(type='radio', name='pageType', value='tattoos', checked=data.pageType=='tattoos')
                                    | Tattoo

                    // SUBMT
                    .form-group
                        label.col-md-4.control-label(for='save')
                        .col-md-8
                            input#pageId(type='hidden', value=data.id)
                            div#results
                            button#save.button(name='save') Save
                            button#cancel.button.alt(name='cancel') Cancel

block append scripts
    script(src="/trumbo/trumbowyg.min.js")
    script(src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js")
    script.
        $(document).ready(function() {
            $('#body').trumbowyg();
            const pageTitle = $('#title');
            pageTitle.keyup((e) => {
                function makeUrl(str) {
                    str = str.trim().toLowerCase();
                    const spaces = /\s+/g;
                    const nonalpha = /[^[A-Za-z0-9\-]+/g;
                    const doubles = /[\-{2,}]+/g;
                    const max = 24;
                    function check(item, repl) {
                        str = str.replace(item, repl);
                    }
                    check(spaces, '-');
                    check(nonalpha, '');
                    check(doubles, '-');
                    if (str.length >= max) {
                        str = str.substr(0, max);
                        const fullwordsonly = str.lastIndexOf('-');
                        if (fullwordsonly > 0) {
                            str = str.substr(0,fullwordsonly);
                        }
                    }
                    return str;
                }
                const t = makeUrl(pageTitle.val());
                $('#url').val(t);
            });
            function getAuthors() {
                var val = $('#authors').val();
                return val.length > 0 ? val : 1;
            }
            $('#save').click(function() {
                const images = $('#images');
                const gallery = images.val().length > 0 ? images.val().split(',') : [];
                const header = $('.image.header').attr('data-image') || gallery[0];
                const data = {
                    id: $('#pageId').val(),
                    authors: getAuthors(),
                    featured: $('#featured').val(),
                    title: $('#title').val(),
                    url: $('#url').val(),
                    body: $('#body').val(),
                    summary: $('#summary').val(),
                    header: header,
                    gallery: gallery.toString(),
                    pagetype: $('[name=pageType]:checked').val(),
                };
                $.ajax({
                    url: '/admin/update',
                    type: 'POST',
                    data: data,
                    error: ((error) => {
                        console.log(`Error: ${error.toString()}`);
                    }),
                    success: ((response) => {
                        console.log('Got a response');
                        if (response.success) {
                            window.location.href = response.url;
                        }
                    })
                });
                return false;
            });
        });
