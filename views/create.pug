extends ./layouts/full

block page_content
    article.box.post
        
        section
            h3 Upload images
                form#uploadForm( enctype="multipart/form-data", action="/upload", method="post")
                    input(type="file", name="userPhoto", multiple)
                    input(type="submit", value="Upload Image", name="submit")
            span#status

        section
            form#new-page.form-horizontal
                fieldset
                    // Form Name
                    h3 New Page
                    // Text input
                    .form-group
                        label.col-md-4.control-label(for='title', placeholder="Title") Title
                        .col-md-5
                            input#title.form-control.input-md(name='title', type='text', placeholder='Title', required='Needs a title!')
                            span.help-block Give it a snazzy title
                    // Text input
                    .form-group
                        label.col-md-4.control-label(for='textinput', placeholder="Url") Url
                        .col-md-5
                            input#url.form-control.input-md(name='textinput', type='text', placeholder='This will auto-fill from title', required='Did you delete the url?', disabled='true')
                    // Textarea
                    .form-group
                        label.col-md-4.control-label(for='summary', required="Summary pls.") Summary
                        .col-md-4
                            textarea#summary.form-control(name='summary', placeholder="Short but sweet.")
                    .form-group
                        label.col-med-4.control-label(for='images', placeholder='Images') Gallery
                        .col-md-4
                            #gallery(style="display:none;")
                    // Textarea
                    .form-group
                        label.col-md-4.control-label(for='trumbowyg') Body
                        .col-md-4
                            textarea#body.form-control(name='trumbowyg', placeholder="Say some good stuff.", required="Say something nice.")
                    // Multiple Radios
                    .form-group
                        label.col-md-4.control-label(for='pageType') Page Type
                        .col-md-4
                            .radio
                                label(for='pageType-0')
                                    input#pageType-0(type='radio', name='pageType', value='blog', checked='checked')
                                    |       Blog
                            .radio
                                label(for='pageType-1')
                                    input#pageType-1(type='radio', name='pageType', value='tattoo')
                                    |       Tattoo
                    // Button (Double)
                    .form-group
                        label.col-md-4.control-label(for='save')
                        .col-md-8
                            button#save.button(name='save') Save
                            button#cancel.button.alt(name='cancel') Cancel


block append scripts
    script(src="/trumbo/trumbowyg.min.js")
    script(src='/unitegallery/themes/tiles/ug-theme-tiles.js')
    script(src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js")
    script.
        $(document).ready(function() {

            function makeUrl(str) {
                str = str.trim();
                const spaces = /\s+/g;
                const nonalpha = /[^[A-Za-z0-9\-]+/g;
                const doubles = /[\-{2,}]+/g;
                const max = 24;
                function check(item, repl) {
                    str = str.replace(item, repl);
                }
                check(spaces, '-');
                check(nonalpha, '');
                check(doubles, '-');
                if (str.length >= max) {
                    str = str.substr(0, max);
                    const fullwordsonly = str.lastIndexOf('-');
                    if (fullwordsonly > 0) {
                        str = str.substr(0,fullwordsonly);
                    }
                }
                return str;
            }
            function initGallery(images = []) {
                const gallery = $('#gallery');
                gallery.css('display','none');
                gallery.empty();
                for(var image in images) {
                    var img = images[image];
                    gallery.append(`<img src='${img}' data-image='${img}' alt='' />`);
                }
                gallery.unitegallery({
                    gallery_theme: "tiles",
                    lightbox_type: "compact"
                });
            };

            $('#body').trumbowyg();
            $('#title').keyup(() => {
                $('#url').val(makeUrl($('#title').val()));
            });
            $('#uploadForm').submit(function() {
                $("#status").empty().text("File is uploading...");
                $(this).ajaxSubmit({
                    error: (xhr) => { status('Error: ' + xhr.status); },
                    success: (response) => { 
                        $("#status").empty().text(response);
                        initGallery([
                            '/images/trm_hand.jpg',
                            '/images/trm_v12.jpg',
                            '/images/trm_fb_banner.jpg',
                            '/images/trm_tw_banner.jpg',
                            '/images/trm_gudruna.jpg',
                            '/images/trm_statue.jpg'
                        ]);
                    }
                });
                return false;
            });
        });
